<h1>Finalizar Pedido</h1>

<p><strong>Produto:</strong> <%= @food.name %></p>

<%= form_with model: @order, url: orders_path(food_id: @food.id) do |f| %>
  <% if @order.errors.any? %>
    <div class="errors" style="color: red; margin-bottom: 20px;">
      <h2><%= pluralize(@order.errors.count, "erro") %> proibiram esse pedido de ser criado:</h2>
      <ul>
        <% @order.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <label>Valor total estimado:</label>
    <span id="estimated_value">
      <%= number_to_currency(@food.price, unit: "R$") %>
    </span>
  </div>

  <div>
    <%= f.label :quantity, "Quantidade" %>
    <%= f.number_field :quantity, min: 1, value: 1, required: true %>
  </div>

  <%= f.hidden_field :estimated_value, id: "order_estimated_value_hidden", value: @food.price %>

  <div>
    <%= f.label :pickup_address_id, "Endereço de Coleta" %>
    <%= f.collection_select :pickup_address_id, @restaurant_addresses, :id,
      ->(a) { "#{a.street}, #{a.number} - #{a.neighborhood}" }, 
      { prompt: "Selecione um endereço de coleta" }, 
      { required: true } %>
  </div>

  <div>
    <%= f.label :delivery_address_id, "Endereço de Entrega" %>
    <%= f.collection_select :delivery_address_id, @client_addresses, :id,
      ->(a) { "#{a.street}, #{a.number} - #{a.neighborhood}" }, 
      { prompt: "Selecione um endereço de entrega" }, 
      { required: true } %>
  </div>

  <div>
    <%= f.label :payment_method, "Método de Pagamento" %>
    <%= f.select :payment_method, Order.payment_methods.keys.map { |m| [m.titleize, m] }, 
        { prompt: "Selecione um método de pagamento" }, 
        { required: true } %>
  </div>

  <%= f.submit "Finalizar Pedido" %>
<% end %>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const quantityInput = document.getElementById("order_quantity");
    const estimatedValueSpan = document.getElementById("estimated_value");
    const hiddenEstimatedValue = document.getElementById("order_estimated_value_hidden");

    const unitPrice = <%= @food.price.to_f %>;

    function updateEstimatedValue() {
      const quantity = parseInt(quantityInput.value) || 1;
      const total = unitPrice * quantity;

      estimatedValueSpan.textContent = total.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });

      if (hiddenEstimatedValue) {
        hiddenEstimatedValue.value = total;
      }
    }

    quantityInput.addEventListener("input", updateEstimatedValue);
    updateEstimatedValue();
  });
</script>
