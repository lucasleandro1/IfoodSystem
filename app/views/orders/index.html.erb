<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
          <i class="fas fa-clipboard-list me-2"></i>
          <%= current_user.restaurante? ? "Pedidos Recebidos" : "Meus Pedidos" %>
        </h1>
        <% if current_user %>
          <div class="alert alert-info d-flex align-items-center">
            <i class="fas fa-user-circle me-2"></i>
            <div>
              <strong>Olá, <%= split_name(current_user.email) %>!</strong>
              <span class="badge bg-secondary ms-2"><%= current_user.role.humanize %></span>
            </div>
          </div>
        <% end %>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <%= form_with url: orders_path, method: :get, local: true do |f| %>
            <div class="row g-3">
              <div class="col-md-2">
                <%= f.label :status, "Status:", class: "form-label" %>
                <%= f.select :status, options_for_select([
                  ['Todos', ''],
                  ['Pendente', 'pendente'],
                  ['Preparando', 'preparando'],
                  ['Em Rota', 'em_rota'],
                  ['Entregue', 'entregue'],
                  ['Cancelado', 'cancelado']
                ], params[:status]), {}, { class: "form-select" } %>
              </div>

              <div class="col-md-2">
                <%= f.label :period, "Período:", class: "form-label" %>
                <%= f.select :period, options_for_select([
                  ['Todos', ''],
                  ['Hoje', 'today'],
                  ['Última semana', 'week'],
                  ['Último mês', 'month']
                ], params[:period]), {}, { class: "form-select" } %>
              </div>

              <div class="col-md-2">
                <%= f.label :date, "Data específica:", class: "form-label" %>
                <%= f.date_field :date, value: params[:date], class: "form-control" %>
              </div>

              <% if current_user.cliente? && @restaurantes.present? %>
                <div class="col-md-3">
                  <%= f.label :restaurante_id, "restaurante:", class: "form-label" %>
                  <%= f.select :restaurante_id, 
                      options_from_collection_for_select(@restaurantes, :id, 
                        lambda { |r| r.email.split('@').first.humanize }, params[:restaurante_id]),
                      { prompt: 'Todos os restaurantes' }, 
                      { class: "form-select" } %>
                </div>
              <% end %>

              <div class="col-md-3 d-flex gap-2 align-items-end">
                <%= f.submit "Filtrar", class: "btn btn-primary" %>
                <%= link_to "Limpar", orders_path, class: "btn btn-outline-secondary" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <% if @orders.any? %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong><%= @orders.total_count %></strong> pedido(s) encontrado(s)
          <% if params[:status].present? || params[:period].present? || params[:date].present? || params[:restaurante_id].present? %>
            com os filtros aplicados
          <% end %>
        </div>

        <div class="row">
          <% @orders.each do |order| %>
            <div class="col-12 mb-4">
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title text-primary mb-0">
                          Pedido #<%= order.id %>
                        </h5>
                        <span class="badge bg-<%= status_badge_class(order.status) %> fs-6">
                          <%= order.status&.humanize || "Indefinido" %>
                        </span>
                      </div>

                      <div class="row mb-3">
                        <div class="col-md-6">
                          <p class="mb-1">
                            <i class="fas fa-clock text-muted me-2"></i>
                            <strong>Data/Hora:</strong> <%= order.requested_at.strftime("%d/%m/%Y às %H:%M") %>
                          </p>
                          <p class="mb-1">
                            <i class="fas fa-utensils text-muted me-2"></i>
                            <strong>Comida:</strong> <%= order.item_description %>
                          </p>
                          <% if current_user.cliente? %>
                            <p class="mb-1">
                              <i class="fas fa-store text-muted me-2"></i>
                              <strong>restaurante:</strong> <%= order.food.user.email.split('@').first.humanize %>
                            </p>
                          <% else %>
                            <p class="mb-1">
                              <i class="fas fa-user text-muted me-2"></i>
                              <strong>cliente:</strong> <%= split_name(order.user.email) %>
                            </p>
                          <% end %>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1">
                            <i class="fas fa-sort-numeric-up text-muted me-2"></i>
                            <strong>Quantidade:</strong> <%= order.quantity %>
                          </p>
                          <p class="mb-1">
                            <i class="fas fa-dollar-sign text-muted me-2"></i>
                            <strong>Valor:</strong> 
                            <span class="price-tag">R$ <%= number_to_currency(order.estimated_value, unit: "", precision: 2) %></span>
                          </p>
                          <p class="mb-1">
                            <i class="fas fa-credit-card text-muted me-2"></i>
                            <strong>Pagamento:</strong> <%= order.payment_method&.humanize || "N/A" %>
                          </p>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <strong>Coleta:</strong><br>
                            <%= "#{order.pickup_address.street}, #{order.pickup_address.number} - #{order.pickup_address.neighborhood}" %>
                          </p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1 text-muted small">
                            <i class="fas fa-home me-1"></i>
                            <strong>Entrega:</strong><br>
                            <%= "#{order.delivery_address.street}, #{order.delivery_address.number} - #{order.delivery_address.neighborhood}" %>
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="d-flex flex-column gap-2">
                      <% if current_user.cliente? %>
                          <%= link_to order_path(order), class: "btn btn-outline-primary" do %>
                            <i class="fas fa-eye me-2"></i>Ver Detalhes
                          <% end %>
                        <% end %>

                        <% if current_user.restaurante? %>
                          <%= form_with model: order, url: order_path(order), method: :patch, local: true do |f| %>
                            <div class="d-flex gap-2">
                              <%= f.select :status, Order.statuses.keys.map { |s| [s.humanize, s] }, 
                                  { selected: order.status }, 
                                  { class: "form-select form-select-sm" } %>
                              <%= f.submit "Atualizar", class: "btn btn-sm btn-success" %>
                            </div>
                          <% end %>
                        <% end %>

                        <% if current_user.cliente? && order.pendente? %>
                          <%= button_to order_path(order), 
                              method: :patch, 
                              params: { order: { status: 'cancelado' } }, 
                              data: { confirm: 'Tem certeza que deseja cancelar o pedido?' },
                              class: "btn btn-sm btn-danger" do %>
                            <i class="fas fa-times me-2"></i>Cancelar Pedido
                          <% end %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
        
        <!-- Pagination -->
        <div class="d-flex flex-column align-items-center mt-4">
          <div class="pagination-info mb-3">
            Página <%= @orders.current_page %> de <%= @orders.total_pages %> - Total: <%= @orders.total_count %> pedidos
          </div>
          <%= paginate @orders %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <div class="mb-4">
            <i class="fas fa-clipboard-list fa-4x text-muted"></i>
          </div>
          <h3 class="text-muted mb-3">Nenhum pedido encontrado</h3>
          <p class="text-muted mb-4">
            <%= if params[:status].present? || params[:period].present? || params[:date].present? || params[:restaurante_id].present?
                  "Tente ajustar os filtros para encontrar pedidos."
                elsif current_user.restaurante?
                  "Ainda não há pedidos para suas comidas."
                else
                  "Você ainda não fez nenhum pedido."
                end %>
          </p>
          <% unless current_user.restaurante? %>
            <%= link_to root_path, class: "btn btn-primary" do %>
              <i class="fas fa-utensils me-2"></i>Ver Comidas Disponíveis
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
